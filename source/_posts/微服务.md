---
title: 微服务
date: 2021-08-16 14:10:00
tags: [微服务, interview]
categories: 微服务
comments: true
---


# 服务注册和服务发现
服务注册和发现中的三个角色: 客户端, 服务端, 注册中心
(1) 服务端启动的时候, 会将服务端的信息(主要是地址信息)注册到注册中心;
(2) 注册中心一般是一个配置中心, 存储了服务端的配置;
(3) 客户端访问服务端, 需要从配置中心找到服务端的配置, 再通过配置信息调用服务端的接口;
(4) 服务端的信息更新, 需要及时同步到注册中心, 防止客户端找不到服务端;
(5) 服务端通过心跳检测等通信机制, 与注册中心通信, 更新注册中心中的配置;

# k8s 中的服务注册和发现
默认情况下, k8s 会为每个 service 分配一个虚拟的 IP 地址 ClusterIP; service 创建后, service 元信息和 ClusterIP 都会被保存在 master 的 etcd 中, 这就是服务注册;
内部服务访问一个 service 的时候, 调用 master 的 coreDns 从 etcd 中获取 service_name 对应的 ClusterIP; 这就是 k8s 中的服务发现;
外部服务访问一个 service 的时候, 服务根据域名解析到 NodeIP 的地址, 通过 NodeIP 路由到对应的 ClusterIP 服务上, 然后按照上述过程访问到具体服务;

# 负载均衡
将工作负载通过各种策略分布到不同的服务器中, 来提高服务的性能;
Node 中的 kube-proxy 会通过系统调用 iptables 或者 IPVS 内核服务, kube-proxy 通过监控 master 的 etcd 更新 iptables 中某个 ClusterIP 的 Endpoints 数组;
iptables 服务或者 IPVS 服务都可以按照配置好的负载均衡规则, 选择合适的 Endpoint 进行请求转发;

# k8s 组件
(1) cluster
(2) node
(3) pod
(4) container

# 常用的 kubectl 命令
kdev = kubectl --namespace=ns --context cluster_name
kdev get pods/nodes/services/configmap | grep [keyword]
kdev describe pod/node/service/configmap [pod_name]
kdev port-forward [pod_name] [port]
kdev logs [pod_name] [contianer_name]
kdev exec -it [pod_name] -- bin/bash



